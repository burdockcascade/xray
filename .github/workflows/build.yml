name: Build

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
        - main
        - master

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      # 1. Install Xmake (Official Action)
      - name: Setup Xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      # 2. Install Linux System Dependencies
      # Raylib requires these OpenGL/Windowing headers to compile on Linux
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxi-dev libxcursor-dev libxrandr-dev libxinerama-dev libx11-dev libwayland-dev libxkbcommon-dev
          xmake f --toolchain=clang --cxx=clang++ --cc=clang --ld=clang++

      # 3. Cache Xmake Packages
      # This caches downloaded libs (Raylib, spdlog) so you don't recompile them every time.
      - name: Retrieve Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.xmake
            build/.deps
          key: ${{ runner.os }}-xmake-${{ hashFiles('**/xmake.lua') }}
          restore-keys: |
            ${{ runner.os }}-xmake-

      # 4. Configure Project
      # -y auto-confirms package installation
      - name: Configure
        run: xmake f -y -m release

      # 5. Build
      - name: Build
        run: xmake

      # 6. Verify Build Artifacts
      # We verify the binary exists. Note: We cannot run the app because CI runners are headless (no screen).
      - name: Verify Binary
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            if [ ! -f "build/windows/x64/release/xray.exe" ]; then echo "Binary missing!"; exit 1; fi
          elif [ "$RUNNER_OS" == "macOS" ]; then
            # macOS path might vary between x64/arm64 depending on the runner hardware
            find build -name "xray" -type f | grep -q . || exit 1
          else
            if [ ! -f "build/linux/x86_64/release/xray" ]; then echo "Binary missing!"; exit 1; fi
          fi
          echo "Build successful."